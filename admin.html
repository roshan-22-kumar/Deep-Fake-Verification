{% extends "layout.html" %}
{% block content %}
  <style>
    .admin-wrap {
      max-width: 1200px;
      margin: 90px auto 40px auto;
      padding: 0 20px;
      color: inherit;
    }

    .admin-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 24px;
    }

    .admin-title h2 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #1E88E5, #FF8C42);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin: 24px 0 28px 0;
    }

    .card {
      padding: 24px;
      border-radius: 16px;
      border: 2px solid;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0,0,0,0.4);
    }

    .card:nth-child(1) {
      background: rgba(30, 136, 229, 0.15);
      border-color: #1E88E5;
    }

    .card:nth-child(2) {
      background: rgba(255, 140, 66, 0.15);
      border-color: #FF8C42;
    }

    .card:nth-child(3) {
      background: rgba(76, 175, 80, 0.15);
      border-color: #4CAF50;
    }

    .card h3 {
      margin: 0 0 10px 0;
      font-size: 0.95rem;
      font-weight: 600;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .card .num {
      font-size: 2.5rem;
      font-weight: 800;
    }

    .card:nth-child(1) .num { color: #1E88E5; }
    .card:nth-child(2) .num { color: #FF8C42; }
    .card:nth-child(3) .num { color: #4CAF50; }

    .filters {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin: 20px 0 16px 0;
    }

    .search-input, .role-select {
      padding: 12px 16px;
      border-radius: 12px;
      border: 2px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      outline: none;
      font-size: 14px;
    }

    .search-input:focus, .role-select:focus {
      border-color: #1E88E5;
      background: rgba(255,255,255,0.15);
    }

    .search-input::placeholder { color: rgba(255,255,255,0.6); }

    .table-card {
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.1);
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      background: rgba(255,255,255,0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: inherit;
    }

    thead th {
      text-align: left;
      padding: 16px;
      background: #1E88E5; /* single solid color in header row */
      color: #fff;
      font-weight: 700;
      font-size: 0.95rem;
    }

    tbody td {
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,0.08);
      vertical-align: middle;
    }

    tbody tr:hover { 
      background: rgba(255,255,255,0.08);
    }

    /* Light mode overrides */
    body:not(.dark-mode) .search-input,
    body:not(.dark-mode) .role-select {
      border: 1px solid #cfcfcf;
      background: #ffffff;
      color: #222222;
    }
    body:not(.dark-mode) .search-input::placeholder { color: #666666; }

    body:not(.dark-mode) .table-card {
      border: 1px solid #e6e6e6;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      background: #ffffff;
    }
    body:not(.dark-mode) tbody tr:hover {
      background: #f7f9fc;
    }
    body:not(.dark-mode) td,
    body:not(.dark-mode) th,
    body:not(.dark-mode) .admin-wrap {
      color: #222222;
    }

    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .badge-admin { 
      background: #FF8C42; 
      color: #fff;
    }
    .badge-user { 
      background: #1E88E5; 
      color: #fff;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .action-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .btn-promote {
      background: #4CAF50;
    }

    .btn-promote:hover {
      background: #45a049;
    }

    .btn-demote {
      background: #FF8C42;
    }

    .btn-demote:hover {
      background: #e67a35;
    }

    .btn-delete {
      background: #E91E63;
    }

    .btn-delete:hover {
      background: #c2185b;
    }

    .tools {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex: 1;
    }

    .btn {
      padding: 12px 20px;
      border-radius: 12px;
      border: none;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .btn-primary { 
      background: #1E88E5;
    }
    .btn-primary:hover {
      background: #1976D2;
    }

    .btn-home { 
      background: #FF8C42;
    }
    .btn-home:hover {
      background: #e67a35;
    }

    .logout-btn {
      background: #E91E63;
    }

    .logout-btn:hover {
      background: #c2185b;
    }
  </style>

  {% set ns = namespace(admins=0, total=0) %}
  {% for u in users %}
    {% set ns.total = ns.total + 1 %}
    {% if u[3] == 'admin' %}{% set ns.admins = ns.admins + 1 %}{% endif %}
  {% endfor %}
  {% set regular = ns.total - ns.admins %}

  <div class="admin-wrap">
    <div class="admin-title">
      <h2>Admin Dashboard</h2>
      <div class="tools">
        <button class="btn btn-primary" onclick="exportCSV()">üìä Export CSV</button>
        <button class="btn btn-home" onclick="window.location='/'">üè† Home</button>
        <button class="btn logout-btn" onclick="window.location='/logout'">üö™ Logout</button>
      </div>
    </div>

    <div class="cards">
      <div class="card">
        <h3>Total Users</h3>
        <div class="num">{{ ns.total }}</div>
      </div>
      <div class="card">
        <h3>Admins</h3>
        <div class="num">{{ ns.admins }}</div>
      </div>
      <div class="card">
        <h3>Regular Users</h3>
        <div class="num">{{ regular }}</div>
      </div>
    </div>

    <div class="filters">
      <input id="search" class="search-input" type="text" placeholder="Search by username or email..." oninput="filterTable()" />
      <select id="roleFilter" class="role-select" onchange="filterTable()">
        <option value="all">All roles</option>
        <option value="admin">Admin</option>
        <option value="user">User</option>
      </select>
    </div>

    <div class="table-card">
      <table id="usersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Username</th>
            <th>Email</th>
            <th>Gender</th>
            <th>Mobile</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user[0] }}</td>
            <td>{{ user[1] }}</td>
            <td>{{ user[2] }}</td>
            <td>{{ user[4] if user[4] else 'N/A' }}</td>
            <td>{{ user[5] if user[5] else 'N/A' }}</td>
            <td>
              {% if user[3] == 'admin' %}
                <span class="badge badge-admin">Admin</span>
              {% else %}
                <span class="badge badge-user">User</span>
              {% endif %}
            </td>
            <td>
              <div class="action-buttons">
                {% if user[3] == 'admin' %}
                  <button class="action-btn btn-demote" data-user-id="{{ user[0] }}" data-username="{{ user[1] }}" data-action="demote">‚¨áÔ∏è Demote</button>
                {% else %}
                  <button class="action-btn btn-promote" data-user-id="{{ user[0] }}" data-username="{{ user[1] }}" data-action="promote">‚¨ÜÔ∏è Promote</button>
                {% endif %}
                <button class="action-btn btn-delete" data-user-id="{{ user[0] }}" data-username="{{ user[1] }}" data-action="delete">üóëÔ∏è Delete</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function filterTable() {
      const term = document.getElementById('search').value.toLowerCase();
      const role = document.getElementById('roleFilter').value;
      const rows = document.querySelectorAll('#usersTable tbody tr');
      rows.forEach(row => {
        const username = row.cells[1].innerText.toLowerCase();
        const email = row.cells[2].innerText.toLowerCase();
        const roleText = row.cells[5].innerText.toLowerCase();
        const matchesTerm = username.includes(term) || email.includes(term);
        const matchesRole = role === 'all' || roleText === role;
        row.style.display = matchesTerm && matchesRole ? '' : 'none';
      });
    }

    function exportCSV() {
      const rows = Array.from(document.querySelectorAll('#usersTable tr'))
        .map(tr => {
          const cells = Array.from(tr.querySelectorAll('th,td'));
          // Skip the Actions column (last column)
          const dataCells = cells.slice(0, -1);
          return dataCells.map(td => {
            const text = td.innerText.trim();
            return '"' + text.replace(/"/g,'""') + '"';
          }).join(',');
        })
        .filter(row => row.trim() !== '') // Remove empty rows
        .join('\n');
      const blob = new Blob([rows], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'users_' + new Date().toISOString().split('T')[0] + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Event delegation for action buttons
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const userId = parseInt(this.getAttribute('data-user-id'));
          const username = this.getAttribute('data-username');
          const action = this.getAttribute('data-action');
          
          if (action === 'promote') {
            promoteUser(userId, username);
          } else if (action === 'demote') {
            demoteUser(userId, username);
          } else if (action === 'delete') {
            deleteUser(userId, username);
          }
        });
      });
    });

    function promoteUser(userId, username) {
      if (confirm(`Are you sure you want to promote "${username}" to Admin?`)) {
        fetch(`/admin/promote/${userId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('User promoted successfully!');
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Failed to promote user'));
          }
        })
        .catch(error => {
          alert('Error: ' + error);
        });
      }
    }

    function demoteUser(userId, username) {
      if (confirm(`Are you sure you want to demote "${username}" from Admin to User?`)) {
        fetch(`/admin/demote/${userId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('User demoted successfully!');
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Failed to demote user'));
          }
        })
        .catch(error => {
          alert('Error: ' + error);
        });
      }
    }

    function deleteUser(userId, username) {
      if (confirm(`‚ö†Ô∏è WARNING: Are you sure you want to DELETE "${username}"? This action cannot be undone!`)) {
        if (confirm(`Final confirmation: Delete user "${username}"?`)) {
          fetch(`/admin/delete/${userId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('User deleted successfully!');
              location.reload();
            } else {
              alert('Error: ' + (data.error || 'Failed to delete user'));
            }
          })
          .catch(error => {
            alert('Error: ' + error);
          });
        }
      }
    }
  </script>
{% endblock %}
